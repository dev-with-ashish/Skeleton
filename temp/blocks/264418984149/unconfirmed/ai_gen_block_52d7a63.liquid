{% doc %}
  @prompt
    cutomizable product section with two layers one for admin to upload shape image and other for user to upload image add mask property to the user image layer so that that user image get the shape of the admin uploaded shape png file
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-custom-product-{{ ai_gen_id }} {
    padding: {{ block.settings.section_padding }}px;
    background-color: {{ block.settings.background_color }};
  }

  .ai-custom-product-container-{{ ai_gen_id }} {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    align-items: center;
  }

  .ai-custom-product-preview-{{ ai_gen_id }} {
    position: relative;
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
  }

  .ai-custom-product-canvas-{{ ai_gen_id }} {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    background-color: {{ block.settings.canvas_background }};
    border-radius: {{ block.settings.canvas_border_radius }}px;
    overflow: hidden;
    border: 2px solid {{ block.settings.canvas_border_color }};
  }

  .ai-custom-product-shape-layer-{{ ai_gen_id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
    pointer-events: none;
  }

  .ai-custom-product-shape-layer-{{ ai_gen_id }} img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .ai-custom-product-user-layer-{{ ai_gen_id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  .ai-custom-product-user-layer-{{ ai_gen_id }} img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    mask-image: var(--ai-mask-image-{{ ai_gen_id }});
    -webkit-mask-image: var(--ai-mask-image-{{ ai_gen_id }});
    mask-size: contain;
    -webkit-mask-size: contain;
    mask-repeat: no-repeat;
    -webkit-mask-repeat: no-repeat;
    mask-position: center;
    -webkit-mask-position: center;
  }

  .ai-custom-product-placeholder-{{ ai_gen_id }} {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f8f8;
    color: #666;
    font-size: 14px;
    text-align: center;
    padding: 20px;
  }

  .ai-custom-product-controls-{{ ai_gen_id }} {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .ai-custom-product-title-{{ ai_gen_id }} {
    font-size: {{ block.settings.title_size }}px;
    color: {{ block.settings.title_color }};
    margin: 0 0 16px;
    font-family: {{ block.settings.title_font.family }}, {{ block.settings.title_font.fallback_families }};
    font-weight: {{ block.settings.title_font.weight }};
  }

  .ai-custom-product-description-{{ ai_gen_id }} {
    color: {{ block.settings.text_color }};
    font-size: {{ block.settings.text_size }}px;
    line-height: 1.5;
    margin-bottom: 24px;
  }

  .ai-custom-product-upload-section-{{ ai_gen_id }} {
    padding: 24px;
    border: 2px dashed {{ block.settings.upload_border_color }};
    border-radius: {{ block.settings.upload_border_radius }}px;
    background-color: {{ block.settings.upload_background }};
    text-align: center;
  }

  .ai-custom-product-upload-label-{{ ai_gen_id }} {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: {{ block.settings.text_color }};
    margin-bottom: 12px;
  }

  .ai-custom-product-upload-input-{{ ai_gen_id }} {
    display: none;
  }

  .ai-custom-product-upload-button-{{ ai_gen_id }} {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background-color: {{ block.settings.button_color }};
    color: {{ block.settings.button_text_color }};
    border: none;
    border-radius: {{ block.settings.button_border_radius }}px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.3s ease;
  }

  .ai-custom-product-upload-button-{{ ai_gen_id }}:hover {
    background-color: {{ block.settings.button_hover_color }};
  }

  .ai-custom-product-upload-info-{{ ai_gen_id }} {
    font-size: 12px;
    color: #666;
    margin-top: 8px;
  }

  .ai-custom-product-preview-info-{{ ai_gen_id }} {
    margin-top: 16px;
    padding: 16px;
    background-color: {{ block.settings.info_background }};
    border-radius: {{ block.settings.info_border_radius }}px;
    font-size: 14px;
    color: {{ block.settings.text_color }};
  }

  .ai-custom-product-reset-button-{{ ai_gen_id }} {
    padding: 8px 16px;
    background-color: transparent;
    color: {{ block.settings.text_color }};
    border: 1px solid {{ block.settings.text_color }};
    border-radius: {{ block.settings.button_border_radius }}px;
    cursor: pointer;
    font-size: 12px;
    margin-top: 8px;
  }

  .ai-custom-product-reset-button-{{ ai_gen_id }}:hover {
    background-color: {{ block.settings.text_color }};
    color: {{ block.settings.background_color }};
  }

  @media screen and (max-width: 768px) {
    .ai-custom-product-container-{{ ai_gen_id }} {
      grid-template-columns: 1fr;
      gap: 24px;
    }

    .ai-custom-product-title-{{ ai_gen_id }} {
      font-size: {{ block.settings.title_size | times: 0.8 }}px;
    }

    .ai-custom-product-upload-section-{{ ai_gen_id }} {
      padding: 16px;
    }
  }
{% endstyle %}

<custom-product-{{ ai_gen_id }}
  class="ai-custom-product-{{ ai_gen_id }}"
  {{ block.shopify_attributes }}
>
  <div class="ai-custom-product-container-{{ ai_gen_id }}">
    <div class="ai-custom-product-preview-{{ ai_gen_id }}">
      <div class="ai-custom-product-canvas-{{ ai_gen_id }}">
        <div class="ai-custom-product-user-layer-{{ ai_gen_id }}">
          <div class="ai-custom-product-placeholder-{{ ai_gen_id }}" id="user-placeholder-{{ ai_gen_id }}">
            Upload your image to see the preview
          </div>
        </div>
        
        {% if block.settings.shape_image %}
          <div class="ai-custom-product-shape-layer-{{ ai_gen_id }}">
            <img
              src="{{ block.settings.shape_image | image_url: width: 500 }}"
              alt="Shape overlay"
              id="shape-image-{{ ai_gen_id }}"
            >
          </div>
        {% endif %}
      </div>
      
      <div class="ai-custom-product-preview-info-{{ ai_gen_id }}">
        <strong>Preview:</strong> Your uploaded image will be masked to match the shape above.
        {% if block.settings.shape_image == blank %}
          <br><em>Admin needs to upload a shape image first.</em>
        {% endif %}
      </div>
    </div>

    <div class="ai-custom-product-controls-{{ ai_gen_id }}">
      {% if block.settings.title != blank %}
        <h2 class="ai-custom-product-title-{{ ai_gen_id }}">{{ block.settings.title }}</h2>
      {% endif %}

      {% if block.settings.description != blank %}
        <div class="ai-custom-product-description-{{ ai_gen_id }}">
          {{ block.settings.description }}
        </div>
      {% endif %}

      <div class="ai-custom-product-upload-section-{{ ai_gen_id }}">
        <label class="ai-custom-product-upload-label-{{ ai_gen_id }}">
          Upload Your Image
        </label>
        
        <input
          type="file"
          accept="image/*"
          class="ai-custom-product-upload-input-{{ ai_gen_id }}"
          id="user-upload-{{ ai_gen_id }}"
        >
        
        <button
          type="button"
          class="ai-custom-product-upload-button-{{ ai_gen_id }}"
          onclick="document.getElementById('user-upload-{{ ai_gen_id }}').click()"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17,8 12,3 7,8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Choose Image
        </button>
        
        <div class="ai-custom-product-upload-info-{{ ai_gen_id }}">
          Supported formats: JPG, PNG, GIF (Max 5MB)
        </div>
        
        <button
          type="button"
          class="ai-custom-product-reset-button-{{ ai_gen_id }}"
          id="reset-button-{{ ai_gen_id }}"
          style="display: none;"
        >
          Remove Image
        </button>
      </div>
    </div>
  </div>
</custom-product-{{ ai_gen_id }}>

<script>
  (function() {
    class CustomProduct{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.userLayer = null;
        this.userPlaceholder = null;
        this.resetButton = null;
        this.fileInput = null;
        this.shapeImage = null;
      }

      connectedCallback() {
        this.userLayer = this.querySelector('.ai-custom-product-user-layer-{{ ai_gen_id }}');
        this.userPlaceholder = this.querySelector('#user-placeholder-{{ ai_gen_id }}');
        this.resetButton = this.querySelector('#reset-button-{{ ai_gen_id }}');
        this.fileInput = this.querySelector('#user-upload-{{ ai_gen_id }}');
        this.shapeImage = this.querySelector('#shape-image-{{ ai_gen_id }}');
        
        this.setupEventListeners();
        this.setupMask();
      }

      setupEventListeners() {
        if (this.fileInput) {
          this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
        }
        
        if (this.resetButton) {
          this.resetButton.addEventListener('click', () => this.resetImage());
        }
      }

      setupMask() {
        if (this.shapeImage) {
          const shapeImageUrl = this.shapeImage.src;
          document.documentElement.style.setProperty(
            '--ai-mask-image-{{ ai_gen_id }}',
            `url(${shapeImageUrl})`
          );
        }
      }

      handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          return;
        }

        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          this.displayUserImage(e.target.result);
        };
        reader.readAsDataURL(file);
      }

      displayUserImage(imageSrc) {
        this.userPlaceholder.style.display = 'none';
        
        let userImage = this.userLayer.querySelector('img');
        if (!userImage) {
          userImage = document.createElement('img');
          this.userLayer.appendChild(userImage);
        }
        
        userImage.src = imageSrc;
        userImage.alt = 'User uploaded image';
        userImage.style.display = 'block';
        
        this.resetButton.style.display = 'inline-block';
      }

      resetImage() {
        const userImage = this.userLayer.querySelector('img');
        if (userImage) {
          userImage.remove();
        }
        
        this.userPlaceholder.style.display = 'flex';
        this.resetButton.style.display = 'none';
        this.fileInput.value = '';
      }
    }

    customElements.define('custom-product-{{ ai_gen_id }}', CustomProduct{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Custom product designer",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Customize Your Product"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>Upload your image and see how it looks with our custom shape overlay. Perfect for creating personalized products.</p>"
    },
    {
      "type": "header",
      "content": "Shape layer (Admin)"
    },
    {
      "type": "image_picker",
      "id": "shape_image",
      "label": "Shape overlay image"
    },
    {
      "type": "paragraph",
      "content": "Upload a PNG image with transparency to create the mask shape for user images."
    },
    {
      "type": "header",
      "content": "Canvas style"
    },
    {
      "type": "color",
      "id": "canvas_background",
      "label": "Canvas background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "canvas_border_color",
      "label": "Canvas border color",
      "default": "#e0e0e0"
    },
    {
      "type": "range",
      "id": "canvas_border_radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "unit": "px",
      "label": "Canvas border radius",
      "default": 8
    },
    {
      "type": "header",
      "content": "Upload section style"
    },
    {
      "type": "color",
      "id": "upload_background",
      "label": "Upload area background",
      "default": "#f8f9fa"
    },
    {
      "type": "color",
      "id": "upload_border_color",
      "label": "Upload border color",
      "default": "#dee2e6"
    },
    {
      "type": "range",
      "id": "upload_border_radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Upload border radius",
      "default": 8
    },
    {
      "type": "header",
      "content": "Button style"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button color",
      "default": "#007bff"
    },
    {
      "type": "color",
      "id": "button_hover_color",
      "label": "Button hover color",
      "default": "#0056b3"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Button border radius",
      "default": 6
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "font_picker",
      "id": "title_font",
      "label": "Title font",
      "default": "helvetica_n4"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 16,
      "max": 48,
      "step": 2,
      "unit": "px",
      "label": "Title size",
      "default": 28
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#333333"
    },
    {
      "type": "range",
      "id": "text_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Text size",
      "default": 16
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#666666"
    },
    {
      "type": "header",
      "content": "Section style"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "info_background",
      "label": "Info box background",
      "default": "#f8f9fa"
    },
    {
      "type": "range",
      "id": "info_border_radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Info box border radius",
      "default": 6
    },
    {
      "type": "range",
      "id": "section_padding",
      "min": 20,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Section padding",
      "default": 40
    }
  ],
  "presets": [
    {
      "name": "Custom product designer"
    }
  ]
}
{% endschema %}